<!-- FEEL FREE TO CHANGE BOTH STUDENT HTML AND ITS CONTROLLERS IT CALLS ALSO IT HAS BUGS DOES NOT DISPLAY THE STUDENTS-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/index.css">  
    <title>Student Details - CourseMap</title>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration: none; color: inherit;">
            <div class="logo">
                <img src="/assets/logo.png" alt="Logo">
                <h1>CourseMap</h1>
            </div>
        </a>
        <input type="checkbox" id="nav_check" hidden>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/professor">Professor</a></li>
                <li><a href="/course">Course</a></li>
                <li><a href="/student" class="active">Student</a></li>
                <li><a href="/assignment">Assignment</a></li>
            </ul>
        </nav>
        <label for="nav_check" class="NavLanscapeStyle">
            <div></div>
            <div></div>
            <div></div>
        </label>
    </header>

    <!--Section center 1-->
    <section class="Center-Section1">
        <img src="/assets/UWT.jpg" alt="UWT Campus">
        <div class="text-container">
            <h1>Student Details</h1>
            <div class="search__container">
                <label for="studentDropdown">Select a Student:</label>
                <select id="studentDropdown" class="search__input">
                    <option value="">Select a student</option>
                </select>
            </div>
        </div>
    </section>

    <!--Section center 2-->
    <section class="Center-Section2">
        <!-- Student Profile -->
        <div class="text-container2" id="studentProfile" style="display: none;">
            <h1>Student Profile</h1>
            <div class="profile-card">
                <div id="profileContent"></div>
            </div>
        </div>

        <!-- Assignment History -->
        <div class="text-container2" id="resultSection" style="display: none;">
            <h1>Assignment History</h1>
            <div class="assignment-history">
                <table>
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Assignment Type</th>
                            <th>Time Spent (hours)</th>
                            <th>Class Average (hours)</th>
                            <th>Difference from Average</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Time Log Form -->
        <div class="text-container2">
            <div class="time-log-container">
                <h1>Log Time for Assignment</h1>
                <form id="timeRecordForm" class="time-log-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assignmentSelect">Assignment:</label>
                            <select id="assignmentSelect" class="search__input" required>
                                <option value="">Select an assignment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timeInput">Time Spent (hours):</label>
                            <input type="number" id="timeInput" class="search__input" step="0.1" min="0.1" required>
                        </div>
                    </div>
                    <button type="submit" class="submit-button">Submit Time</button>
                </form>
                <div id="formMessage" class="message-alert" style="display: none;"></div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <a href="/">
                <img src="/assets/logo.png" alt="CourseMap Logo">
            </a>
            <p>Â© 2024 CourseMap, LLC. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const studentDropdown = document.getElementById('studentDropdown');
            const assignmentSelect = document.getElementById('assignmentSelect');
            const resultSection = document.getElementById('resultSection');
            const resultTableBody = document.getElementById('resultTableBody');
            const timeRecordForm = document.getElementById('timeRecordForm');
            const studentProfile = document.getElementById('studentProfile');
            const profileContent = document.getElementById('profileContent');
            const formMessage = document.getElementById('formMessage');

            // Load students
            try {
                const response = await fetch('/students');
                const students = await response.json();
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.StuEmail;
                    option.textContent = `${student.LName}, ${student.FName}`;
                    studentDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching students:', error);
            }

            // Handle student selection
            studentDropdown.addEventListener('change', async (event) => {
                const email = event.target.value;
                if (!email) {
                    resultSection.style.display = 'none';
                    studentProfile.style.display = 'none';
                    return;
                }

                try {
                    // Fetch and display student profile
                    const studentResponse = await fetch(`/students?email=${email}`);
                    const studentData = await studentResponse.json();
                    studentProfile.style.display = 'block';
                    profileContent.innerHTML = `
                        <div class="profile-info">
                            <p><strong>Name:</strong> ${studentData.FName} ${studentData.LName}</p>
                            <p><strong>Email:</strong> ${studentData.StuEmail}</p>
                            <p><strong>Major:</strong> ${studentData.Major}</p>
                        </div>
                    `;

                    // Fetch and display assignment history
                    const historyResponse = await fetch(`/students/details?email=${email}`);
                    const historyData = await historyResponse.json();
                    resultTableBody.innerHTML = '';
                    resultSection.style.display = 'block';

                    historyData.forEach(record => {
                        const timeDiff = (record.TimeInput - record.StuAvgTime).toFixed(2);
                        const diffClass = timeDiff > 0 ? 'above-average' : 'below-average';
                        
                        resultTableBody.innerHTML += `
                            <tr>
                                <td>${record.CourseName}</td>
                                <td>${record.AssignmentType}</td>
                                <td>${record.TimeInput}</td>
                                <td>${record.StuAvgTime}</td>
                                <td class="${diffClass}">${timeDiff} hours</td>
                            </tr>
                        `;
                    });

                    if (historyData.length === 0) {
                        resultTableBody.innerHTML = '<tr><td colspan="5">No assignment history found.</td></tr>';
                    }
                } catch (error) {
                    console.error('Error fetching student details:', error);
                }
            });

            // Handle time record submission
            timeRecordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const studentEmail = studentDropdown.value;
                const assignId = assignmentSelect.value;
                const timeInput = document.getElementById('timeInput').value;

                if (!studentEmail) {
                    showMessage('Please select a student first', 'error');
                    return;
                }

                try {
                    const response = await fetch('/timerecord', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            studentEmail,
                            assignId,
                            timeInput: parseFloat(timeInput)
                        })
                    });

                    if (response.ok) {
                        showMessage('Time record added successfully!', 'success');
                        timeRecordForm.reset();
                        studentDropdown.dispatchEvent(new Event('change'));
                    } else {
                        showMessage('Error adding time record', 'error');
                    }
                } catch (error) {
                    console.error('Error submitting time record:', error);
                    showMessage('Error submitting time record', 'error');
                }
            });

            function showMessage(message, type) {
                formMessage.textContent = message;
                formMessage.className = `message-alert ${type}`;
                formMessage.style.display = 'block';
                setTimeout(() => {
                    formMessage.style.display = 'none';
                }, 3000);
            }

            // Load assignments for the form
            try {
                const response = await fetch('/assignments');
                const assignments = await response.json();
                assignments.forEach(assignment => {
                    const option = document.createElement('option');
                    option.value = assignment.AssignID;
                    option.textContent = `${assignment.AssignmentType} - ${assignment.CourseName}`;
                    assignmentSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching assignments:', error);
            }
        });
    </script>
</body>
</html>
